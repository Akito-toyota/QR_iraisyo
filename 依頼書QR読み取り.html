<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åŸå QR ç…§åˆ</title>

<!-- âœ… QRèª­ã¿å–ã‚Š -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>

<!-- âœ… Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
  background: #f5f7fb;
  padding: 20px;
}

h2 {
  color: #333;
}

button {
  padding: 12px 18px;
  border-radius: 8px;
  border: none;
  background: #4f6df5;
  color: white;
  font-size: 16px;
  font-weight: 600;
  margin-right: 5px;
}

button:disabled {
  background: #aaa;
}

input[type="file"] {
  background: white;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

table {
  width: 100%;
  max-width: 700px;
  background: white;
  border-radius: 10px;
  border-collapse: collapse;
  margin-top: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

th {
  background: #4f6df5;
  color: white;
  padding: 10px;
}

td {
  padding: 10px;
  border-bottom: 1px solid #eee;
}

.pending { background: #fafafa; }
.done { background: #e6f8ea; font-weight: 600; }

#reader {
  margin-top: 15px;
  max-width: 320px;
  background: white;
  border-radius: 10px;
  padding: 10px;
}

#reader video {
  width: 100%;
  border-radius: 10px;
}

#message {
  margin-top: 12px;
  font-size: 18px;
  font-weight: 600;
}
</style>
</head>

<body>

<h2>åŸå QR ç…§åˆ</h2>

<input type="file" id="excelFile" accept=".xlsx,.xlsm"><br><br>

<button id="startBtn">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
<button id="stopBtn" disabled>â¹ åœæ­¢</button>

<table>
<thead>
<tr>
  <th>ç•ªå·</th>
  <th>å†…å®¹</th>
  <th>çŠ¶æ…‹</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<p>èª­ã¿å–ã£ãŸQRï¼š<strong id="qrText">æœªèª­è¾¼</strong></p>
<div id="message"></div>

<div id="reader"></div>

<script>
let rows = [];
let scanned = new Set();
let qr = null;

const tbody = document.getElementById("list");
const messageEl = document.getElementById("message");
const qrTextEl = document.getElementById("qrText");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

/* =====================
   Excelèª­ã¿è¾¼ã¿
===================== */
document.getElementById("excelFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = ev => {
    const wb = XLSX.read(new Uint8Array(ev.target.result), { type: "array" });
    const sheet = wb.Sheets["QRã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ"];
    if (!sheet) {
      alert("ã‚·ãƒ¼ãƒˆã€QRã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }

    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    rows = data
      .filter(r => r[0] && r[1])
      .map(r => ({ a: r[0], b: r[1], done: false }));

    scanned.clear();
    messageEl.textContent = "";
    render();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

/* =====================
   è¡¨ç¤ºæ›´æ–°
===================== */
function render() {
  tbody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = r.done ? "done" : "pending";
    tr.innerHTML = `
      <td>${r.a}</td>
      <td>${r.b}</td>
      <td>${r.done ? "âœ… å®Œäº†" : "â³ æœªå–å¾—"}</td>
    `;
    tbody.appendChild(tr);
  });

  if (rows.length && rows.every(r => r.done)) {
    messageEl.textContent = "ğŸ‰ å…¨ã¦ã®åŸåç…§åˆãŒå®Œäº†ã—ã¾ã—ãŸ";
    messageEl.style.color = "green";
    stopCamera();
  }
}

/* =====================
   ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆPC / iPhoneå¯¾å¿œï¼‰
===================== */
startBtn.addEventListener("click", async () => {
  if (!qr) qr = new Html5Qrcode("reader");

  startBtn.disabled = true;
  stopBtn.disabled = false;

  try {
    await qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250, aspectRatio: 1.0 },
      text => {
        qrTextEl.textContent = text;

        if (scanned.has(text)) return;

        const hit = rows.find(r => r.b === text && !r.done);
        if (hit) {
          hit.done = true;
          scanned.add(text);
          navigator.vibrate?.(200);
          messageEl.textContent = "";
          render();
        } else {
          messageEl.textContent = "âŒ ä¸€è‡´ã—ã¾ã›ã‚“";
          messageEl.style.color = "red";
        }
      }
    );
  } catch (e) {
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—ï¼š" + e);
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }
});

/* =====================
   ã‚«ãƒ¡ãƒ©åœæ­¢
===================== */
stopBtn.addEventListener("click", stopCamera);

async function stopCamera() {
  if (qr) {
    await qr.stop();
    await qr.clear();
  }
  startBtn.disabled = false;
  stopBtn.disabled = true;
}
</script>

</body>
</html>